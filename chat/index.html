<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <title>Modern Messenger</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little bit of custom CSS for scrollbars and other minor tweaks */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Typing indicator animation */
        .ellipsis span { opacity: 0; animation: ellipsis 1.4s infinite; }
        .ellipsis span:nth-child(2) { animation-delay: 0.2s; }
        .ellipsis span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes ellipsis { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body class="h-full bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans antialiased">

    <div id="app" class="h-full flex flex-col">
        <!-- Main container -->
        <div class="container mx-auto flex-1 flex h-full p-2 sm:p-4 gap-4">

            <!-- Sidebar for navigation -->
            <aside class="w-16 sm:w-20 md:w-64 flex flex-col bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-2 sm:p-4">
                <h1 class="text-xl sm:text-2xl font-bold mb-4 hidden md:block">Messenger</h1>
                <div class="flex-1 space-y-2">
                    <button class="tab-btn w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-lg bg-blue-500 text-white shadow" onclick="switchTab('public')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        <span class="hidden md:inline">Public Chat</span>
                    </button>
                    <button class="tab-btn w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" onclick="switchTab('dms')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span class="hidden md:inline">DMs</span>
                    </button>
                    <button class="tab-btn w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" onclick="switchTab('groups')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span class="hidden md:inline">Groups</span>
                    </button>
                </div>
                 <div class="mt-auto">
                    <button class="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" onclick="showGlobalSearch()">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <span class="hidden md:inline">Search</span>
                    </button>
                </div>
            </aside>

            <!-- Main Chat Area -->
            <main class="flex-1 flex flex-col bg-white dark:bg-slate-800 rounded-2xl shadow-lg">
                <!-- Public Chat View -->
                <div id="public-chat-view" class="chat-view active flex flex-col h-full">
                    <header class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center gap-4">
                         <h2 class="text-xl font-bold">Public Chat</h2>
                    </header>
                    <div id="chat" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
                    <div id="public-controls" class="p-4 border-t border-slate-200 dark:border-slate-700"></div>
                </div>

                <!-- DMs View -->
                <div id="dm-view" class="chat-view hidden h-full">
                    <div class="flex h-full">
                        <div class="w-1/3 border-r border-slate-200 dark:border-slate-700 flex flex-col">
                            <h3 class="p-4 text-lg font-semibold">Friends</h3>
                            <div id="friend-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                        </div>
                        <div class="w-2/3 flex flex-col">
                            <div id="dm-chat-header" class="p-4 border-b border-slate-200 dark:border-slate-700"></div>
                            <div id="dm-chat" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
                            <div id="dm-controls" class="p-4 border-t border-slate-200 dark:border-slate-700"></div>
                        </div>
                    </div>
                </div>

                <!-- Groups View -->
                <div id="group-view" class="chat-view hidden h-full">
                    <div class="flex h-full">
                        <div class="w-1/3 border-r border-slate-200 dark:border-slate-700 flex flex-col">
                            <div class="p-4 flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Groups</h3>
                                <button class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" onclick="createGroup()">‚ûï</button>
                            </div>
                            <div id="group-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                        </div>
                        <div class="w-2/3 flex flex-col">
                            <div id="group-header" class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center gap-3 cursor-pointer" style="display: none;"></div>
                            <div id="group-chat" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
                            <div id="group-controls" class="p-4 border-t border-slate-200 dark:border-slate-700"></div>
                        </div>
                    </div>
                </div>

                <!-- Shared Controls (Template) -->
                <div id="controls-template" class="hidden">
                    <div id="typing-indicator" class="h-5 text-sm italic text-slate-500 px-2"></div>
                    <div id="reply-preview" class="hidden p-2 bg-slate-100 dark:bg-slate-700 rounded-lg mb-2 flex justify-between items-center text-sm"></div>
                    <div id="emoji-bar" class="flex flex-wrap gap-2 mb-2 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg"></div>
                    <div class="flex items-center gap-2">
                         <div class="flex-shrink-0">
                             <input type="text" class="username-input bg-slate-100 dark:bg-slate-700 rounded-full px-4 py-2 w-32 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Username">
                         </div>
                        <div class="relative flex-1">
                            <input type="text" class="message-input w-full bg-slate-100 dark:bg-slate-700 rounded-full py-2 pl-4 pr-28 outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message...">
                            <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center">
                                 <button class="sendImageBtn p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600">üñºÔ∏è</button>
                                 <button class="addEmojiBtn p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600">üòÄ</button>
                            </div>
                        </div>
                        <button class="send-btn bg-blue-500 text-white rounded-full px-5 py-2 font-semibold hover:bg-blue-600 disabled:bg-slate-400">Send</button>
                    </div>
                    <input type="file" class="imageUpload hidden" accept="image/*">
                    <input type="file" class="emojiUpload hidden" accept="image/png, image/gif">
                </div>
            </main>
        </div>
        
        <p class="text-xs text-center text-slate-400 dark:text-slate-600 pb-2">
            Note: This chat is file-based. Simultaneous actions might result in one being lost.
        </p>
    </div>
    
    <!-- All hidden inputs for file uploads -->
    <input type="file" id="pfpUpload" class="hidden" accept="image/*">
    <input type="file" id="bannerUpload" class="hidden" accept="image/*">

    <!-- All Modals -->
    <div id="profile-preview-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center" onclick="this.style.display='none'">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm overflow-hidden" onclick="event.stopPropagation()">
            <div id="profile-modal-banner" class="h-32 bg-slate-200 dark:bg-slate-700 bg-cover bg-center"></div>
            <div class="p-4 relative">
                <div id="profile-modal-pfp" class="absolute -top-12 left-4 w-24 h-24 rounded-full bg-slate-300 dark:bg-slate-600 border-4 border-white dark:border-slate-800 bg-cover bg-center">
                    <div id="profile-modal-status" class="absolute bottom-1 right-1 w-4 h-4 rounded-full border-2 border-white dark:border-slate-800"></div>
                </div>
                <div class="pt-12">
                    <h3 id="profile-modal-username" class="text-2xl font-bold"></h3>
                    <p id="profile-modal-bio" class="text-slate-500 mt-1"></p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="search-modal-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden items-start justify-center pt-20" onclick="this.style.display='none'">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-xl" onclick="event.stopPropagation()">
            <input type="text" id="global-search-input" placeholder="Search users, groups, or announcements..." oninput="performSearch()" class="w-full p-4 bg-transparent text-lg outline-none border-b border-slate-200 dark:border-slate-700">
            <div id="search-results" class="max-h-[60vh] overflow-y-auto"></div>
            <div class="p-2 text-right">
                 <button onclick="document.getElementById('search-modal-backdrop').style.display='none'" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GITHUB_API_URL = 'https://api.github.com/repos/Bob-2015/bob-2015.github.io/contents/chat/chat.txt?ref=main';
        // Note: Writing to a file-based chat via GitHub API from the client-side is complex and requires authentication.
        // The `updateFile` functionality has been disabled. This is now a read-only chat client.
        const TYPING_STATUS_URL = 'http://192.168.3.19:8181/servers/chat/copy%202/typing.json';
        const READ_STATUS_URL = 'http://192.168.3.19:8181/servers/chat/copy%202/read-status.json';
        const DEFAULT_REACTIONS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üôè'];
        
        // --- DOM ELEMENTS ---
        const chatBox = document.getElementById('chat');
        const dmChatBox = document.getElementById('dm-chat');
        const groupChatBox = document.getElementById('group-chat');
        const friendList = document.getElementById('friend-list');
        const groupList = document.getElementById('group-list');
        const searchInput = document.getElementById('global-search-input');
        const searchResultsContainer = document.getElementById('search-results');

        // --- STATE & OBSERVERS ---
        let customEmojis = {}; 
        let userProfiles = {};
        let friends = new Set();
        let groups = {};
        let customTags = {};
        let lastKnownSha = null;
        let lastKnownContent = '';
        let replyContext = null; 
        let typingTimeout;
        let currentTab = 'public';
        let currentDmUser = null;
        let currentGroupId = null;
        let allMessages = [];

        // --- CORE LOGIC ---
        async function fetchMessages() {
            try {
                const headers = {};
                // If we've fetched before, use the SHA to check for changes
                if (lastKnownSha) {
                    headers['If-None-Match'] = lastKnownSha;
                }
                const response = await fetch(GITHUB_API_URL, { cache: 'no-store', headers });
                
                // 304 Not Modified means the file hasn't changed.
                if (response.status === 304) {
                    return;
                }

                if (!response.ok) {
                    throw new Error(`GitHub API responded with ${response.status}`);
                }
                
                lastKnownSha = response.headers.get('ETag');
                const data = await response.json();
                
                // The content from GitHub API is base64 encoded.
                const decodedContent = atob(data.content);

                if (decodedContent !== lastKnownContent) {
                    lastKnownContent = decodedContent;
                    parseAllMessages(decodedContent);
                    renderChat();
                }
            } catch (error) { 
                console.error('Error fetching chat file from GitHub:', error); 
                // Display error in chat
                const activeChatBox = getActiveChatBox();
                if (activeChatBox) {
                    activeChatBox.innerHTML = `<div class="text-center text-red-500 p-4">Could not load chat. Is the repository public?</div>`;
                }
            }
        }

        function parseAllMessages(data) {
            // Reset aggregated data
            customEmojis = {}; userProfiles = {}; friends.clear(); groups = {}; customTags = {};
            const deletedMessageIds = new Set();
            const editedMessages = {};
            allMessages = []; // Clear previous messages

            const lines = data.split('\n').filter(line => line.trim() !== '');

            lines.forEach(line => {
                try {
                    const msg = JSON.parse(line);
                    allMessages.push(msg); // Store raw message
                    
                    switch(msg.type) {
                        case 'emoji': customEmojis[msg.name] = msg.content; break;
                        case 'delete': deletedMessageIds.add(msg.targetId); break;
                        case 'edit': editedMessages[msg.targetId] = msg.newContent; break;
                        case 'set_profile_picture': userProfiles[msg.username] = { ...userProfiles[msg.username], pfp: msg.picture }; break;
                        case 'set_banner': userProfiles[msg.username] = { ...userProfiles[msg.username], banner: msg.banner }; break;
                        case 'set_status': userProfiles[msg.username] = { ...userProfiles[msg.username], status: msg.status }; break;
                        case 'set_bio': userProfiles[msg.username] = { ...userProfiles[msg.username], bio: msg.bio }; break;
                        case 'accept_friend':
                            if (msg.users.includes(getActiveUsername())) {
                               const friend = msg.users.find(u => u !== getActiveUsername());
                               friends.add(friend);
                            }
                            break;
                        case 'create_group':
                            groups[msg.groupId] = { id: msg.groupId, name: msg.name, members: new Set([msg.creator]), admins: new Set([msg.creator]), picture: null, banner: null, description: '', type: msg.groupType };
                            break;
                        case 'edit_group_name': if(groups[msg.groupId]) groups[msg.groupId].name = msg.newName; break;
                        case 'edit_group_picture': if(groups[msg.groupId]) groups[msg.groupId].picture = msg.picture; break;
                        case 'edit_group_banner': if(groups[msg.groupId]) groups[msg.groupId].banner = msg.banner; break;
                        case 'edit_group_description': if(groups[msg.groupId]) groups[msg.groupId].description = msg.description; break;
                        case 'add_group_member': if(groups[msg.groupId]) groups[msg.groupId].members.add(msg.userToAdd); break;
                        case 'make_group_admin': if(groups[msg.groupId]) groups[msg.groupId].admins.add(msg.userToPromote); break;
                        case 'delete_group': delete groups[msg.groupId]; break;
                        case 'create_tag': customTags[msg.name] = { users: msg.users }; break;
                    }
                } catch (e) { console.warn("Could not parse line:", line, e) }
            });
            
            // Apply edits and deletions
            allMessages = allMessages.filter(msg => !deletedMessageIds.has(msg.timestamp));
            allMessages.forEach(msg => {
                if (editedMessages[msg.timestamp]) {
                    msg.content = editedMessages[msg.timestamp];
                    msg.edited = true;
                }
            });

            updateSidebars();
        }

        function parseTextFormatting(text) {
            let html = escapeHTML(text);
            html = html.replace(/
